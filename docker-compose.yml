version: '3'

x-var: &NGIN_PORT
        9080:8000
x-var: &DJANGO_PORT
        8000
x-var: &MYSQL_PORT
        3306:3306
x-var:  &PHP_PORT
        9090:80
x-var:  &ROOT_PASS
        P@ssw0rd
x-var:  &PASS
        P@ssw0rd
x-var:  &USER
        site_db
x-var:  &DATABASE
        site_db
x-var:  &HOST
        mysql

services:
    django:
        build: .
        command: gunicorn -b 0.0.0.0:8000 -w 4 site_project.wsgi # <-- for production, 4 workers
        volumes:
            - ./site_project:/home/site_project
        expose:
            - *DJANGO_PORT
        depends_on: # <-- wait for mysql to be "ready" before starting this service
            - mysql
        networks:
            - nginx_network
            - mysql_network
    nginx:
        restart: always
        image: nginx:1.13
        ports:
            - *NGIN_PORT
        volumes:
            - ./config/nginx/conf.d:/etc/nginx/conf.d # <-- for using non-SSL
#            - ./config/nginx-ssl/conf.d:/etc/nginx/conf.d <-- for using SSL
#            - ./config/ssl/your_domain.com.crt:/etc/nginx/your_domain.com.crt # <-- your SSL certificate here
#            - ./config/ssl/your_domain.com.key:/etc/nginx/your_domain.com.key # <-- your key here
            - ./logs:/home/site_project/logs
            - ./site_project/media:/home/site_project/media
            - ./site_project/static:/home/site_project/static
        depends_on:  # <-- wait for django to be "ready" before starting this service
            - django
        networks:
            - nginx_network
    mysql:
        image: mysql:5.7
        volumes:
            - ./mysql/data:/var/lib/mysql
            - ./mysql/dump:/docker-entrypoint-initdb.d
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: *ROOT_PASS
            MYSQL_DATABASE: *DATABASE
            MYSQL_USER: *USER
            MYSQL_PASSWORD: *PASS
        command: ['mysqld', '--character-set-server=utf8', '--collation-server=utf8_unicode_ci']
        ports:
            - *MYSQL_PORT
        networks:
            - mysql_network
    phpmyadmin:
        depends_on:
            - mysql
        image: phpmyadmin/phpmyadmin
        restart: always
        ports:
            - *PHP_PORT
        environment:
            PMA_HOST: *HOST
            MYSQL_ROOT_PASSWORD: *ROOT_PASS
        networks:
            - mysql_network
networks:
    nginx_network:
        driver: bridge
    mysql_network:
        driver: bridge
